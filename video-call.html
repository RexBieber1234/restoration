<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RCC call page</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body { background: #121212; color: white; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
    #videos { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
    video { width: 100%; border-radius: 10px; border: 2px solid #333; background: black; }
    #controls { margin-top: 15px; }
    button, input { padding: 10px; font-size: 16px; margin: 5px; border: none; border-radius: 5px; }
    button { background: #333; color: white; cursor: pointer; }
    button:hover { background: #555; }
  </style>
</head>
<body>
  <h1>ðŸŽ¥ Call A friend by sharing the code(id) below</h1>
  <p>Your ID: <span id="my-id">Loading...</span></p>
  <input id="room-id" placeholder="Enter Room ID" />
  <button onclick="joinRoom()">Join</button>

  <div id="controls" style="display:none;">
    <button onclick="toggleAudio()">ðŸŽ¤ Mute/Unmute</button>
    <button onclick="toggleVideo()">ðŸŽ¥ Video On/Off</button>
  </div>

  <div id="videos"></div>

  <script>
    const maxUsers = 6;
    let peer = new Peer();
    let connections = {};
    let myStream = null;
    let myId = null;
    let roomId = '';
    let videoContainer = document.getElementById("videos");

    peer.on("open", id => {
      myId = id;
      document.getElementById("my-id").textContent = id;
    });

    function joinRoom() {
      roomId = document.getElementById("room-id").value.trim();
      if (!roomId) return alert("Enter a room ID");

      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        myStream = stream;
        document.getElementById("controls").style.display = "block";
        addVideo(myId, stream, true);

        const conn = peer.connect(roomId);
        conn.on("open", () => {
          conn.send({ type: "join", id: myId });
        });

        peer.on("connection", c => {
          c.on("data", data => {
            if (data.type === "join") {
              if (Object.keys(connections).length >= maxUsers - 1) return;
              if (!connections[data.id]) {
                const call = peer.call(data.id, myStream);
                setupCall(call);
              }
            }
          });
        });

        peer.on("call", call => {
          if (Object.keys(connections).length >= maxUsers - 1 || connections[call.peer]) return;
          call.answer(myStream);
          setupCall(call);
        });
      });
    }

    function setupCall(call) {
      call.on("stream", remoteStream => {
        addVideo(call.peer, remoteStream, false);
      });
      call.on("close", () => {
        removeVideo(call.peer);
      });
      connections[call.peer] = call;
    }

    function addVideo(id, stream, isMine) {
      if (document.getElementById(id)) return;
      if (videoContainer.children.length >= maxUsers) return;

      const vid = document.createElement("video");
      vid.id = id;
      vid.srcObject = stream;
      vid.autoplay = true;
      vid.playsInline = true;
      if (isMine) vid.muted = true;
      videoContainer.appendChild(vid);
    }

    function removeVideo(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
      delete connections[id];
    }

    function toggleAudio() {
      if (!myStream) return;
      myStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
    }

    function toggleVideo() {
      if (!myStream) return;
      myStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
    }
  </script>
</body>
</html>
