<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RCC CALL PAGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h2 {
      background: #1f1f1f;
      padding: 15px;
      margin: 0;
    }
    #videos {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px;
    }
    .video-box {
      position: relative;
      margin: 10px;
    }
    video {
      width: 100%;
      max-width: 300px;
      border: 2px solid #444;
      border-radius: 10px;
    }
    .video-name {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(0,0,0,0.6);
      padding: 2px 6px;
      font-size: 14px;
      border-radius: 5px;
    }
    .controls {
      margin-top: 10px;
    }
    button, input {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
    }
    .share-buttons {
      margin-top: 10px;
    }
    @media screen and (max-width: 600px) {
      video {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<h2>ðŸ“ž Call a friend by sharing the code (ID) below</h2>
<p>Your ID: <span id="my-id">Loading...</span></p>
<p>Call Duration: <span id="call-duration">00:00</span></p>
<input id="peer-id-input" placeholder="Enter Peer ID to call" />
<button id="call-btn"><i class="fas fa-phone"></i> Call</button>
<button id="exit-btn"><i class="fas fa-sign-out-alt"></i> Exit</button>

<div class="share-buttons">
  <button onclick="copyLink()"><i class="fas fa-copy"></i> Copy Link</button>
  <a id="whatsapp-share" target="_blank">
    <button><i class="fab fa-whatsapp"></i> Share on WhatsApp</button>
  </a>
</div>

<div id="videos"></div>

<script>
  const maxUsers = 6;
  const videoContainer = document.getElementById("videos");
  const myIdSpan = document.getElementById("my-id");
  const callBtn = document.getElementById("call-btn");
  const peerIdInput = document.getElementById("peer-id-input");
  const exitBtn = document.getElementById("exit-btn");
  const callDuration = document.getElementById("call-duration");

  let localStream, myId, callTimer;
  const peer = new Peer();
  const connections = {};
  const joinedIds = new Set();

  function createVideoBox(id, stream, label = "User") {
    if (document.getElementById("video-" + id)) return;

    const box = document.createElement("div");
    box.className = "video-box";
    box.id = "video-" + id;

    const video = document.createElement("video");
    video.autoplay = true;
    video.playsInline = true;
    video.srcObject = stream;
    if (id === myId) video.muted = true;

    const name = document.createElement("div");
    name.className = "video-name";
    name.innerText = label;

    box.appendChild(video);
    box.appendChild(name);
    videoContainer.appendChild(box);
  }

  function removeVideoBox(id, message = null) {
    const box = document.getElementById("video-" + id);
    if (box) {
      const label = box.querySelector('.video-name');
      if (message) {
        label.innerText = message;
      } else {
        box.remove();
      }
    }
  }

  function updateShareLinks() {
    const url = `${location.href}#${myId}`;
    document.getElementById("whatsapp-share").href =
      `https://wa.me/?text=Join my call: ${url}`;
  }

  function copyLink() {
    const link = `${location.href}#${myId}`;
    navigator.clipboard.writeText(link);
    alert("Link copied!");
  }

  function formatTime(s) {
    const m = Math.floor(s / 60).toString().padStart(2, '0');
    const sec = (s % 60).toString().padStart(2, '0');
    return `${m}:${sec}`;
  }

  function startTimer() {
    let secs = 0;
    callTimer = setInterval(() => {
      secs++;
      callDuration.innerText = formatTime(secs);
    }, 1000);
  }

  peer.on("open", id => {
    myId = id;
    myIdSpan.innerText = id;
    updateShareLinks();
  });

  navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
    localStream = stream;
    createVideoBox(myId, stream, "Me");
  });

  peer.on("call", call => {
    if (Object.keys(connections).length >= maxUsers - 1) {
      alert("Max users reached");
      return call.close();
    }

    call.answer(localStream);
    call.on("stream", remoteStream => {
      connections[call.peer] = call;
      joinedIds.add(call.peer);
      createVideoBox(call.peer, remoteStream, "Friend");
    });

    call.on("close", () => {
      removeVideoBox(call.peer, "User has exited");
      joinedIds.delete(call.peer);
      delete connections[call.peer];
    });
  });

  callBtn.onclick = async () => {
    const peerId = peerIdInput.value.trim();
    if (!peerId || peerId === myId) return;

    if (joinedIds.has(peerId)) return alert("Already connected.");
    if (Object.keys(connections).length >= maxUsers - 1) return alert("Max users reached");

    const call = peer.call(peerId, localStream);
    call.on("stream", remoteStream => {
      connections[peerId] = call;
      joinedIds.add(peerId);
      createVideoBox(peerId, remoteStream, "Friend");
      if (!callTimer) startTimer();
    });

    call.on("close", () => {
      removeVideoBox(peerId, "User has exited");
      joinedIds.delete(peerId);
      delete connections[peerId];
    });
  };

  exitBtn.onclick = () => {
    Object.values(connections).forEach(call => call.close());
    removeVideoBox(myId, "You exited");
    if (callTimer) clearInterval(callTimer);
  };
</script>
</body>
</html>
