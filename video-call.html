<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Group Video Call</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
    }
    header {
      background: #1f1f1f;
      padding: 10px;
      display: flex;
      justify-content: space-between;
    }
    button, input {
      padding: 8px;
      margin: 4px;
      border: none;
      border-radius: 4px;
    }
    .dark-mode body {
      background: #fff;
      color: #000;
    }
    video {
      width: 200px;
      height: 150px;
      margin: 5px;
      background: black;
    }
    #videos {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    #status {
      margin: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<header>
  <div>
    <button onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
    <button onclick="logout()">ðŸ”“ Logout</button>
  </div>
  <div>
    <span id="status">Offline</span>
  </div>
</header>

<div style="text-align: center; margin-top: 20px;">
  <input type="text" id="roomCode" placeholder="Room Code">
  <input type="password" id="roomPassword" placeholder="Room Password">
  <button onclick="createRoom()">Create Room</button>
  <button onclick="joinRoom()">Join Room</button>
</div>

<div id="videos"></div>

<script>
let localStream;
let peerConnections = {};
let roomCode = '';
let username = '';
let roomPassword = '';
let online = false;

const servers = {
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
};

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

function logout() {
  localStorage.clear();
  location.reload();
}

function updateStatus() {
  document.getElementById("status").textContent = online ? "ðŸŸ¢ Online" : "ðŸ”´ Offline";
}

async function getMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const video = document.createElement('video');
    video.srcObject = localStream;
    video.autoplay = true;
    video.muted = true;
    document.getElementById('videos').appendChild(video);
  } catch (e) {
    alert('Permission denied or no camera/mic found.');
  }
}

function createRoom() {
  roomCode = document.getElementById("roomCode").value.trim();
  roomPassword = document.getElementById("roomPassword").value.trim();
  if (!roomCode || !roomPassword) return alert("Both room code and password required.");

  localStorage.setItem("room", roomCode);
  localStorage.setItem("password", roomPassword);

  online = true;
  updateStatus();
  initSocket(true);
}

function joinRoom() {
  roomCode = document.getElementById("roomCode").value.trim();
  roomPassword = document.getElementById("roomPassword").value.trim();
  if (!roomCode || !roomPassword) return alert("Both room code and password required.");

  localStorage.setItem("room", roomCode);
  localStorage.setItem("password", roomPassword);

  online = true;
  updateStatus();
  initSocket(false);
}

function send(msg) {
  ws.send(JSON.stringify({ ...msg, roomCode, roomPassword }));
}

let ws;

function initSocket(isHost) {
  getMedia().then(() => {
    ws = new WebSocket("wss://your-signaling-server.glitch.me");

    ws.onopen = () => {
      send({ type: "join", isHost, name: username });
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);

      if (data.error) return alert(data.error);

      switch (data.type) {
        case "offer":
          const pc = createPeerConnection(data.name);
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          send({ type: "answer", answer, to: data.name });
          break;

        case "answer":
          await peerConnections[data.name]?.setRemoteDescription(new RTCSessionDescription(data.answer));
          break;

        case "candidate":
          await peerConnections[data.name]?.addIceCandidate(new RTCIceCandidate(data.candidate));
          break;

        case "users":
          data.users.forEach(user => {
            if (user !== username && Object.keys(peerConnections).length < 6) {
              const pc = createPeerConnection(user);
              localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
              pc.createOffer().then(offer => {
                pc.setLocalDescription(offer);
                send({ type: "offer", offer, to: user });
              });
            }
          });
          break;
      }
    };
  });
}

function createPeerConnection(name) {
  const pc = new RTCPeerConnection(servers);
  peerConnections[name] = pc;

  pc.onicecandidate = e => {
    if (e.candidate) {
      send({ type: "candidate", candidate: e.candidate, to: name });
    }
  };

  pc.ontrack = e => {
    const video = document.createElement('video');
    video.srcObject = e.streams[0];
    video.autoplay = true;
    document.getElementById('videos').appendChild(video);
  };

  return pc;
}

// Auto-login if credentials exist
window.onload = () => {
  username = prompt("Enter your name or nickname:") || "User" + Math.floor(Math.random() * 1000);
  const storedRoom = localStorage.getItem("room");
  const storedPass = localStorage.getItem("password");
  if (storedRoom && storedPass) {
    document.getElementById("roomCode").value = storedRoom;
    document.getElementById("roomPassword").value = storedPass;
    joinRoom();
  }
};
</script>
</body>
</html>
